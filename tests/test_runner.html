<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Racing Line Tests</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #00d9ff; margin-bottom: 20px; }
    .controls {
      margin-bottom: 20px;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      margin-right: 10px;
    }
    button:hover { background: #00b8d9; }
    button:disabled { background: #666; cursor: not-allowed; }
    
    .summary {
      background: #2a2a4e;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 18px;
    }
    .summary.all-pass { border-left: 4px solid #00ff88; }
    .summary.has-fail { border-left: 4px solid #ff4444; }
    
    .test-list { list-style: none; padding: 0; margin: 0; }
    .test-item {
      background: #2a2a4e;
      margin-bottom: 10px;
      padding: 15px 20px;
      border-radius: 8px;
      border-left: 4px solid #666;
    }
    .test-item.pass { border-left-color: #00ff88; }
    .test-item.fail { border-left-color: #ff4444; }
    .test-item.pending { border-left-color: #ffaa00; }
    
    .test-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .test-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .test-status.pass { background: #00ff88; color: #000; }
    .test-status.fail { background: #ff4444; color: #fff; }
    .test-status.pending { background: #ffaa00; color: #000; }
    
    .test-message {
      color: #aaa;
      font-size: 14px;
      margin-top: 5px;
    }
    
    .visualizer {
      margin-top: 30px;
      background: #2a2a4e;
      border-radius: 8px;
      padding: 20px;
    }
    .visualizer h2 { margin-top: 0; color: #00d9ff; }
    canvas {
      background: #1a1a2e;
      border-radius: 4px;
      display: block;
      margin: 10px auto;
    }
    select {
      background: #1a1a2e;
      color: #eee;
      border: 1px solid #444;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>üèéÔ∏è Racing Line Algorithm Tests</h1>
  
  <div class="controls">
    <button id="runAllBtn">Run All Tests</button>
    <button id="runSelectedBtn">Run Selected</button>
  </div>
  
  <div id="summary" class="summary" style="display:none;"></div>
  
  <ul id="testList" class="test-list"></ul>
  
  <div class="visualizer">
    <h2>Track Visualizer</h2>
    <select id="trackSelect">
      <option value="hairpin">Hairpin</option>
      <option value="90corner">90¬∞ Corner</option>
      <option value="gentleSCurve">Gentle S-Curve</option>
      <option value="chicane">Chicane</option>
      <option value="wavyTrack">Wavy Track</option>
      <option value="circle">Circle</option>
    </select>
    <button id="visualizeBtn">Visualize</button>
    <canvas id="trackCanvas" width="800" height="600"></canvas>
  </div>

  <!-- Load dependencies -->
  <script src="../utils/utils.js"></script>
  <script src="../ai/mcp_racing_line.js"></script>
  <script src="../ai/racing_line_validation.js"></script>
  <script src="../ai/racer_ai.js"></script>
  <script src="racing_line_tests.js"></script>
  
  <script>
    const testListEl = document.getElementById('testList');
    const summaryEl = document.getElementById('summary');
    const runAllBtn = document.getElementById('runAllBtn');
    const runSelectedBtn = document.getElementById('runSelectedBtn');
    const trackSelect = document.getElementById('trackSelect');
    const visualizeBtn = document.getElementById('visualizeBtn');
    const canvas = document.getElementById('trackCanvas');
    const ctx = canvas.getContext('2d');

    // Populate test list
    function populateTests() {
      testListEl.innerHTML = '';
      RacingLineTests.tests.forEach((test, idx) => {
        const li = document.createElement('li');
        li.className = 'test-item pending';
        li.innerHTML = `
          <input type="checkbox" checked data-idx="${idx}">
          <span class="test-name">${test.name}</span>
          <span class="test-status pending">PENDING</span>
          <div class="test-message">Click "Run" to execute</div>
        `;
        testListEl.appendChild(li);
      });
    }

    // Update test result in UI
    function updateTestResult(idx, result) {
      const item = testListEl.children[idx];
      const status = item.querySelector('.test-status');
      const message = item.querySelector('.test-message');
      
      item.className = `test-item ${result.pass ? 'pass' : 'fail'}`;
      status.className = `test-status ${result.pass ? 'pass' : 'fail'}`;
      status.textContent = result.pass ? 'PASS' : 'FAIL';
      message.textContent = result.message;
    }

    // Run all tests
    runAllBtn.onclick = function() {
      runAllBtn.disabled = true;
      const result = RacingLineTests.runAll();
      
      result.results.forEach((r, idx) => {
        updateTestResult(idx, r);
      });
      
      summaryEl.style.display = 'block';
      summaryEl.className = `summary ${result.failed === 0 ? 'all-pass' : 'has-fail'}`;
      summaryEl.textContent = `Results: ${result.passed}/${result.passed + result.failed} tests passed`;
      
      runAllBtn.disabled = false;
    };

    // Run selected tests
    runSelectedBtn.onclick = function() {
      const checkboxes = testListEl.querySelectorAll('input[type="checkbox"]:checked');
      let passed = 0, failed = 0;
      
      checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        const result = RacingLineTests.runTest(idx);
        updateTestResult(idx, result);
        if (result.pass) passed++; else failed++;
      });
      
      summaryEl.style.display = 'block';
      summaryEl.className = `summary ${failed === 0 ? 'all-pass' : 'has-fail'}`;
      summaryEl.textContent = `Results: ${passed}/${passed + failed} tests passed`;
    };

    // Visualize track and racing line
    visualizeBtn.onclick = function() {
      const trackType = trackSelect.value;
      const tracks = RacingLineTests.tracks;
      
      let centerline;
      switch (trackType) {
        case 'hairpin':
          centerline = tracks.generateHairpin(400, 500, 200, 120, 1);
          break;
        case '90corner':
          centerline = tracks.generate90Corner(300, 500, 200, 80, 1);
          break;
        case 'gentleSCurve':
          centerline = tracks.generateGentleSCurve(50, 300, 700, 25, 2);
          break;
        case 'chicane':
          centerline = tracks.generateChicane(50, 300, 150, 60, 120);
          break;
        case 'wavyTrack':
          centerline = tracks.generateWavyTrack(50, 200, 700, 20, 4);
          break;
        case 'circle':
          centerline = tracks.generateCircle(400, 300, 200, 80);
          break;
      }
      
      const roadWidth = 200;
      const racingLine = RacerAI.buildRacingLine(centerline, roadWidth);
      
      // Clear canvas
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw track surface
      ctx.strokeStyle = '#444';
      ctx.lineWidth = roadWidth;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(centerline[0].x, centerline[0].y);
      for (let i = 1; i < centerline.length; i++) {
        ctx.lineTo(centerline[i].x, centerline[i].y);
      }
      ctx.closePath();
      ctx.stroke();
      
      // Draw centerline
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(centerline[0].x, centerline[0].y);
      for (let i = 1; i < centerline.length; i++) {
        ctx.lineTo(centerline[i].x, centerline[i].y);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Draw racing line
      ctx.strokeStyle = '#00d9ff';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(racingLine[0].x, racingLine[0].y);
      for (let i = 1; i < racingLine.length; i++) {
        ctx.lineTo(racingLine[i].x, racingLine[i].y);
      }
      ctx.closePath();
      ctx.stroke();
      
      // Draw racing line dots
      ctx.fillStyle = 'rgba(0, 217, 255, 0.5)';
      for (let i = 0; i < racingLine.length; i += 3) {
        ctx.beginPath();
        ctx.arc(racingLine[i].x, racingLine[i].y, 5, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Mark high-curvature points (apices)
      ctx.fillStyle = '#ff4444';
      for (let i = 0; i < racingLine.length; i++) {
        if (Math.abs(racingLine[i].curvature) > 0.003) {
          ctx.beginPath();
          ctx.arc(racingLine[i].x, racingLine[i].y, 8, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    };

    // Initialize
    populateTests();
  </script>
</body>
</html>
