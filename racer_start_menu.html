<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0f0f12" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>RacingVibes - Menu</title>

  <!-- Preload fonts if possible or use system stack -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,600;0,700;0,800;1,400;1,700&family=Rajdhani:wght@500;600;700&display=swap"
    rel="stylesheet">

  <script src="ai/racer_ai.js" defer></script>
  <script src="utils/storage-utils.js" defer></script>
  <script src="track_storage.js" defer></script>
  <script src="track_editor.js" defer></script>
  <script src="track_builder.js" defer></script>

  <style>
    :root {
      --bg-dark: #0a0a0c;
      --bg-panel: #131317;
      --bg-card: #1c1c22;
      --accent: #ef4444;
      /* Racing Red */
      --accent-glow: rgba(239, 68, 68, 0.4);
      --text-main: #ffffff;
      --text-muted: #94a3b8;

      --font-display: 'Rajdhani', sans-serif;
      --font-body: 'Exo 2', sans-serif;

      --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      background-color: var(--bg-dark);
      background-image:
        radial-gradient(circle at 50% 0%, #2a2a35 0%, transparent 70%),
        linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111),
        linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111);
      background-size: 100% 100%, 20px 20px, 20px 20px;
      background-position: 0 0, 0 0, 10px 10px;
      color: var(--text-main);
      font-family: var(--font-body);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Screen Container */
    #app {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      perspective: 1000px;
    }

    /* ===== Background Elements ===== */
    .racing-flag-bg {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: repeating-linear-gradient(45deg, #ffffff05 0, #ffffff05 20px, transparent 20px, transparent 40px);
      pointer-events: none;
      z-index: 0;
    }

    /* ===== Header ===== */
    header {
      padding: 24px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .logo {
      font-family: var(--font-display);
      font-size: 42px;
      font-weight: 800;
      text-transform: uppercase;
      font-style: italic;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }

    .logo span {
      color: var(--accent);
    }

    /* ===== Layouts ===== */
    .screen {
      position: absolute;
      inset: 0;
      padding: 100px 40px 40px;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px) scale(0.98);
      transition: opacity 0.4s ease, transform 0.4s var(--ease-out);
      z-index: 1;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
      z-index: 2;
    }

    /* ===== Main Menu Grid ===== */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: minmax(0, 1fr);
      gap: 20px;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      height: 60%;
    }

    .menu-item {
      position: relative;
      background: linear-gradient(160deg, #2a2a30, #16161a);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .menu-item::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.1), transparent 60%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .menu-item:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 20px var(--accent-glow);
    }

    .menu-item:hover::before {
      opacity: 1;
    }

    .menu-item:active {
      transform: translateY(-2px);
    }

    .menu-item.selected {
      background: linear-gradient(135deg, #2a1010, var(--bg-card));
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .menu-icon {
      font-size: 48px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
    }

    .menu-label {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Large items span 2 columns */
    .menu-item.large {
      grid-column: span 2;
    }

    /* Locked items */
    .menu-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.8);
    }

    .menu-item.locked::after {
      content: 'ðŸ”’';
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 16px;
    }

    /* ===== Free Play Wizard ===== */
    .wizard-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .wizard-header {
      display: flex;
      align-items: center;
      margin-bottom: 40px;
      gap: 20px;
    }

    .back-btn {
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: white;
    }

    .wizard-title {
      font-family: var(--font-display);
      font-size: 32px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .wizard-steps {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .step-dot {
      width: 40px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .step-dot.active {
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .step-dot.done {
      background: white;
    }

    /* Selection Grid for Vehicles/Tracks/Classes */
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      padding-bottom: 100px;
      overflow-y: auto;
      padding-right: 12px;
    }

    .selection-grid::-webkit-scrollbar {
      width: 6px;
    }

    .selection-grid::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .card.selected {
      background: linear-gradient(135deg, #2a1010, var(--bg-card));
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .card-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .card-icon img {
      width: 1em;
      height: 1em;
      object-fit: contain;
      display: block;
    }

    .card-title {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      /* Add shadow for readability */
    }

    .card-desc {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
      position: relative;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      /* Add shadow for readability */
    }

    .card-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      z-index: 2;
      /* Ensure badge is on top */
      backdrop-filter: blur(4px);
      /* Blur background behind badge */
    }

    /* Track Card Action Buttons */
    .card-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: absolute;
      top: 8px;
      left: 8px;
      margin: 0;
      width: auto;
      z-index: 10;
    }

    .card-action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-muted);
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .card-action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-color: rgba(255, 255, 255, 0.4);
    }

    .card-action-btn.export:hover {
      background: rgba(74, 222, 128, 0.2);
      border-color: rgba(74, 222, 128, 0.5);
      color: #4ade80;
    }

    .card-action-btn.rename:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: rgba(250, 204, 21, 0.5);
      color: #facc15;
    }

    .card-action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      color: #ef4444;
    }

    /* Settings Form */
    .settings-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      max-width: 900px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .range-wrap {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    input[type=range] {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      appearance: none;
    }

    input[type=range]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 15px var(--accent);
      cursor: pointer;
      transition: transform 0.1s;
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .range-val {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      color: white;
      min-width: 60px;
      text-align: right;
    }

    /* Start Button Area */
    .action-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 30px 40px;
      background: linear-gradient(to top, #0a0a0c 80%, transparent);
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .start-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px 48px;
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 4px;
      cursor: pointer;
      clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%);
      transition: all 0.2s;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    }

    .start-btn:hover {
      background: #ff5555;
      transform: translateX(5px);
      box-shadow: 0 10px 40px rgba(239, 68, 68, 0.5);
    }

    /* ===== COMPREHENSIVE RESPONSIVE DESIGN ===== */

    /* Base fluid sizing using clamp for smooth scaling */
    :root {
      --header-padding: clamp(12px, 3vw, 40px);
      --screen-padding: clamp(16px, 4vw, 40px);
      --gap-size: clamp(8px, 2vw, 20px);
      --logo-size: clamp(24px, 5vw, 42px);
      --title-size: clamp(18px, 4vw, 32px);
      --card-padding: clamp(12px, 3vw, 24px);
      --icon-size: clamp(28px, 6vw, 48px);
      --label-size: clamp(14px, 3vw, 24px);
    }

    /* Override base styles with fluid values */
    header {
      padding: var(--header-padding);
    }

    .logo {
      font-size: var(--logo-size);
    }

    .screen {
      padding: clamp(140px, 18vh, 180px) var(--screen-padding) var(--screen-padding);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .menu-grid {
      flex: 1;
      width: 100%;
      height: 100%;
      max-height: none;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: minmax(0, 1fr);
      gap: var(--gap-size);
    }

    /* Ensure content inside wizard container also fills space if needed */
    .wizard-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .menu-icon {
      font-size: var(--icon-size);
      margin-bottom: clamp(8px, 2vw, 16px);
    }

    .menu-label {
      font-size: var(--label-size);
    }

    .wizard-header {
      margin-bottom: clamp(16px, 3vh, 40px);
      flex-wrap: wrap;
    }

    .wizard-title {
      font-size: var(--title-size);
    }

    .back-btn {
      width: clamp(36px, 6vw, 48px);
      height: clamp(36px, 6vw, 48px);
      font-size: clamp(16px, 3vw, 20px);
    }

    .step-dot {
      width: clamp(24px, 5vw, 40px);
      height: clamp(2px, 0.5vh, 4px);
    }

    .selection-grid {
      padding-bottom: clamp(60px, 10vh, 100px);
      max-height: calc(100vh - clamp(180px, 25vh, 250px));
      gap: var(--gap-size);
    }

    .card {
      padding: var(--card-padding);
    }

    .card-icon {
      font-size: var(--icon-size);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .card-title {
      font-size: clamp(16px, 3vw, 24px);
      margin-bottom: clamp(4px, 1vw, 8px);
    }

    .card-desc {
      font-size: clamp(11px, 2vw, 14px);
    }

    .action-bar {
      padding: clamp(16px, 3vh, 30px) var(--screen-padding);
    }

    .start-btn {
      padding: clamp(10px, 2vh, 16px) clamp(24px, 5vw, 48px);
      font-size: clamp(16px, 3vw, 24px);
    }

    .settings-form {
      gap: clamp(16px, 4vw, 40px);
    }

    .form-group {
      margin-bottom: clamp(12px, 3vw, 24px);
    }

    .range-val {
      font-size: clamp(16px, 3vw, 24px);
      min-width: clamp(40px, 8vw, 60px);
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */

    /* Desktop (1440px+) - Full layout */
    @media (min-width: 1440px) {
      .menu-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1400px;
      }

      .selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
    }

    /* Laptop (1025px - 1439px) */
    @media (max-width: 1439px) and (min-width: 1025px) {
      .menu-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 1200px;
      }

      .selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      }
    }

    /* Tablet (769px - 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
      .menu-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .menu-item.large {
        grid-column: span 1;
      }

      .selection-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .settings-form {
        grid-template-columns: 1fr 1fr;
      }

      /* Scale wizard title for tablet */
      .wizard-title {
        font-size: 26px;
      }
    }

    /* Small Tablet / Large Phone (481px - 768px) */
    @media (max-width: 768px) and (min-width: 481px) {
      .screen {
        padding-top: clamp(50px, 8vh, 70px);
        padding-left: 12px;
        padding-right: 12px;
      }

      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
        max-height: calc(100vh - clamp(70px, 10vh, 100px));
        gap: 8px;
      }

      .menu-item.large {
        grid-column: span 1;
      }

      .menu-item {
        min-height: 0;
        padding: clamp(8px, 2vw, 14px);
      }

      /* Compact wizard for small tablets */
      .wizard-container {
        max-height: calc(100vh - clamp(60px, 9vh, 80px));
      }

      .wizard-header {
        gap: 10px;
        margin-bottom: 12px;
      }

      .wizard-title {
        font-size: 22px;
      }

      .back-btn {
        width: 38px;
        height: 38px;
        font-size: 16px;
      }

      .step-dot {
        width: 28px;
        height: 3px;
      }

      /* Compact selection grid to fit all 6 cards */
      .selection-grid {
        grid-template-columns: repeat(2, 1fr);
        max-height: calc(100vh - 120px);
        gap: 8px;
        padding-bottom: 60px;
        overflow: hidden;
      }

      /* Compact cards with hidden descriptions */
      .card {
        min-height: 0;
        max-height: calc((100vh - 220px) / 3);
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .card-icon {
        font-size: 22px;
        margin-bottom: 4px;
      }

      .card-title {
        font-size: 13px;
        margin-bottom: 0;
      }

      /* Hide descriptions to save space */
      /* Show description but limit lines */
      .card-desc {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-top: 4px;
        font-size: 10px;
        line-height: 1.2;
      }

      .settings-form {
        grid-template-columns: 1fr;
      }
    }

    /* Mobile (480px and below) */
    @media (max-width: 480px) {
      .screen {
        padding-top: clamp(80px, 12vh, 100px);
        padding-left: 8px;
        padding-right: 8px;
        padding-bottom: 8px;
      }

      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .menu-item.large {
        grid-column: span 1;
      }

      .menu-item {
        min-height: 0;
        padding: clamp(6px, 1.5vw, 12px);
      }

      /* Compact wizard container */
      .wizard-container {
        max-height: calc(100vh - clamp(45px, 7vh, 60px));
      }

      /* Very compact wizard header */
      .wizard-header {
        gap: 6px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }

      .wizard-title {
        font-size: 18px;
      }

      .back-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .wizard-steps {
        margin-left: auto;
      }

      .step-dot {
        width: 20px;
        height: 3px;
      }

      /* Selection grid for wizard steps - 2 columns with very compact cards */
      .selection-grid {
        grid-template-columns: repeat(2, 1fr);
        max-height: calc(100vh - 100px);
        gap: 5px;
        padding-bottom: 50px;
        overflow: hidden;
      }

      /* Very compact cards for mobile - hide descriptions to fit 6 in view */
      .card {
        min-height: 0;
        max-height: calc((100vh - 180px) / 3);
        padding: 5px 6px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }

      .card-icon {
        font-size: 16px;
        margin-bottom: 2px;
      }

      .card-title {
        font-size: 10px;
        margin-bottom: 0;
      }

      /* Hide descriptions on mobile to save space */
      /* Show description but limit lines */
      .card-desc {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-top: 2px;
        font-size: 9px;
        line-height: 1.1;
      }

      .card-badge {
        font-size: 7px;
        padding: 2px 3px;
        top: 2px;
        right: 2px;
      }

      .settings-form {
        grid-template-columns: 1fr;
        overflow-y: auto;
        max-height: calc(100vh - clamp(100px, 15vh, 140px));
      }

      /* Smaller sliders on mobile */
      input[type=range] {
        height: 4px;
      }

      input[type=range]::-webkit-slider-thumb {
        width: 18px;
        height: 18px;
        margin-top: -7px;
      }

      .action-bar {
        padding: 16px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        justify-content: center;
        /* Center the button */
        background: linear-gradient(to top, #0a0a0c 90%, transparent);
        /* Ensure visibility over content */
      }

      .start-btn {
        width: auto;
        min-width: 200px;
        text-align: center;
        padding: 16px 32px;
        /* Bigger padding */
        font-size: 18px;
        /* Bigger font */
        border-radius: 50px;
        /* Rounded pill style */
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
        /* Make it pop */
      }

      /* Player info in header */
      header {
        padding: 8px 12px;
      }

      .logo {
        font-size: 22px;
      }
    }

    /* Very small screens (360px and below) - common on older devices */
    @media (max-width: 360px) {
      .menu-grid {
        gap: 4px;
      }

      .menu-icon {
        margin-bottom: 4px;
      }

      .selection-grid {
        gap: 4px;
      }

      .card-icon {
        margin-bottom: 8px;
      }

      .card-desc {
        display: none;
        /* Hide descriptions on very small screens */
      }

      /* Even smaller wizard title for small screens */
      .wizard-title {
        font-size: 16px;
      }
    }

    /* Landscape mobile - important for phones rotated horizontal */
    @media (max-height: 500px) and (orientation: landscape) {
      header {
        padding: 4px var(--header-padding);
        display: flex;
        align-items: center;
      }

      .logo {
        font-size: clamp(16px, 4vw, 24px);
      }

      .screen {
        padding-top: clamp(60px, 12vh, 80px);
      }

      .menu-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .menu-icon {
        font-size: clamp(16px, 4vw, 24px);
        margin-bottom: 2px;
      }

      .menu-label {
        font-size: clamp(10px, 2vw, 14px);
      }

      /* Wizard Container - scrollable if needed */
      .wizard-container {
        max-height: none;
        overflow-y: auto;
      }

      .wizard-header {
        margin-bottom: 4px;
      }

      /* Smaller wizard title for landscape */
      .wizard-title {
        font-size: 20px;
      }

      /* Selection Grid: auto-fit square cards */
      .selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        grid-auto-rows: auto;
        max-height: none;
        padding-bottom: 50px;
        gap: 6px;
        overflow-y: visible;
      }

      /* Square cards - maintain aspect ratio */
      .card {
        aspect-ratio: 1;
        max-height: none;
        min-height: 0;
        height: auto;
        padding: 6px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .card-icon {
        font-size: 14px;
        margin-bottom: 2px;
      }

      .card-title {
        font-size: 10px;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-desc {
        display: none;
        /* Hide description to save space in square cards */
      }

      /* Thumbnail: scale to fill square card */
      .card-thumbnail {
        flex: 1;
        min-height: 0;
        max-height: none;
        margin-top: 8px;
        margin-bottom: 4px;
        background-size: contain;
        background-position: center;
      }

      /* Connected, centered and compact slider layout */
      .range-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 4px;
        width: 100%;
      }

      input[type=range] {
        height: 4px;
        flex: 0 0 120px;
        /* Fixed length */
        width: 120px;
      }

      input[type=range]::-webkit-slider-thumb {
        width: 16px;
        height: 16px;
        margin-top: -7px;
      }

      .range-val {
        font-size: 13px;
        color: var(--accent);
        /* Highlight value */
        width: 130px;
        /* Fixed space for long labels */
        text-align: left;
        white-space: nowrap;
      }

      /* Settings Form: 2 columns, centered items with toggle space */
      /* Settings Form: Confined width for better centering */
      .settings-form {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        align-items: start;
        padding-bottom: 80px;
        /* Ensure space for overlapping Action Bar */
        max-width: 560px;
        /* Bring sliders closer to center */
        margin: 0 auto;
      }



      .form-group {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        /* Left-align labels and inputs for consistency */
      }

      .form-label {
        font-size: 10px;
        margin-bottom: 4px;
        color: #aaa;
        width: 260px;
        /* Match content width */
        text-align: left;
        /* Left align to setting */
        transform: none;
      }

      /* Ensure range-wrap matches label width for alignment */
      .form-group .range-wrap {
        width: 260px;
      }

      /* Game Options below left sliders */
      .form-group:last-child {
        grid-column: auto;
        margin-top: 10px;
      }

      .form-group:last-child>div {
        width: 260px;
        /* Match slider group width */
        box-sizing: border-box;
        padding: 0 !important;
        /* Remove excessive padding */
        background: none !important;
        border: none !important;
      }

      /* Force Sound Effects layout: Text Left, Checkbox Right */
      /* Exclude #ghostToggleLbl to respect its JavaScript-controlled display */
      .form-group:last-child>div label:not(#ghostToggleLbl) {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      /* Style Ghost toggle when visible (Time Trial mode) */
      #ghostToggleLbl {
        justify-content: space-between;
        width: 100%;
      }

      .action-bar {
        padding: 8px var(--screen-padding);
      }

      .start-btn {
        padding: 8px 24px;
        font-size: 14px;
      }
    }

    /* Short screens (height-based only, for better DevTools compatibility) */
    /* Scale entire track cards to fit 2 full rows on screen */
    @media (max-height: 500px) {
      .wizard-title {
        font-size: 20px;
      }

      .wizard-header {
        margin-bottom: 8px;
      }

      /* Selection grid: auto-fit square cards */
      .selection-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        grid-auto-rows: auto;
        gap: 6px;
        overflow-y: visible;
        max-height: none;
        padding-bottom: 50px;
      }

      /* Square cards - maintain aspect ratio */
      .card {
        aspect-ratio: 1;
        padding: 4px;
        max-height: none;
        min-height: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .card-icon {
        font-size: 12px;
        margin-bottom: 2px;
      }

      .card-title {
        font-size: 9px;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .card-desc {
        display: none;
        /* Hide description in square cards */
      }

      .card-badge {
        font-size: 6px;
        padding: 2px 4px;
        top: 2px;
        right: 2px;
      }

      /* Thumbnail: scale within square card */
      .card-thumbnail {
        flex: 1;
        min-height: 0;
        max-height: none;
        margin-top: 6px;
        margin-bottom: 2px;
        background-size: contain;
        background-position: center;
      }

      .wizard-container {
        overflow-y: auto;
      }
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    /* NEW badge for custom tracks */
    .card-badge-new {
      position: absolute;
      top: 40px;
      /* Position below the Custom badge */
      right: 8px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
      animation: badge-pulse 1.5s ease-in-out infinite;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
      z-index: 5;
    }

    @keyframes badge-pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
      }

      50% {
        opacity: 0.8;
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.6);
      }
    }

    /* Purple pulsing animation for new custom tracks (same style as GT Class green glow) */
    @keyframes pulse-purple-glow {
      0% {
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
        border-color: rgba(139, 92, 246, 0.5);
      }

      50% {
        box-shadow: 0 0 20px 4px rgba(139, 92, 246, 0.3);
        border-color: rgba(139, 92, 246, 1);
        transform: translateY(-2px);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
        border-color: rgba(139, 92, 246, 0.5);
      }
    }

    /* New custom track card with purple pulsing outline */
    .card.card-new-track {
      animation: pulse-purple-glow 3s infinite ease-in-out;
      border-color: rgba(139, 92, 246, 0.6);
    }

    /* Track Name Modal */
    .track-name-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      animation: modal-fade-in 0.3s ease forwards;
    }

    @keyframes modal-fade-in {
      to {
        opacity: 1;
      }
    }

    .track-name-modal {
      background: linear-gradient(135deg, #1a1a20 0%, #0f0f14 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transform: scale(0.9) translateY(20px);
      animation: modal-slide-in 0.3s ease forwards;
    }

    @keyframes modal-slide-in {
      to {
        transform: scale(1) translateY(0);
      }
    }

    .track-name-modal h2 {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .track-name-modal p {
      color: var(--text-muted);
      font-size: 14px;
      margin: 0 0 24px 0;
    }

    .track-name-modal input {
      width: 100%;
      padding: 14px 16px;
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 600;
      color: white;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }

    .track-name-modal input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
    }

    .track-name-modal input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .track-name-modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .track-name-modal-buttons button {
      flex: 1;
      padding: 14px 24px;
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .track-name-modal-buttons .btn-cancel {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-muted);
    }

    .track-name-modal-buttons .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .track-name-modal-buttons .btn-save {
      background: var(--accent);
      border: none;
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .track-name-modal-buttons .btn-save:hover {
      background: #ff5555;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    /* Track Thumbnail */
    /* Track Thumbnail */
    .card-thumbnail {
      flex: 1;
      width: 100%;
      min-height: 120px;
      max-height: 200px;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      margin-bottom: 8px;
      margin-top: 28px;
      /* Increased margin to clear badges */
      position: relative;
      opacity: 1;
      z-index: 0;
    }

    /* =========================================
       TRACK SUCCESS CELEBRATION SCREEN
       ========================================= */
    .track-success-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0a0a0c 0%, #1a1a20 50%, #0f0f14 100%);
      z-index: 4000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      animation: success-fade-in 0.5s ease forwards;
    }

    @keyframes success-fade-in {
      to {
        opacity: 1;
      }
    }

    .track-success-content {
      text-align: center;
      transform: scale(0.8) translateY(30px);
      animation: success-slide-in 0.6s ease 0.2s forwards;
      opacity: 0;
    }

    @keyframes success-slide-in {
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .track-success-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: success-bounce 1s ease 0.5s;
    }

    @keyframes success-bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-20px);
      }

      50% {
        transform: translateY(0);
      }

      70% {
        transform: translateY(-10px);
      }
    }

    .track-success-title {
      font-family: var(--font-display);
      font-size: 42px;
      font-weight: 700;
      color: white;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 4px;
    }

    .track-success-subtitle {
      font-size: 18px;
      color: var(--text-muted);
      margin: 0 0 40px 0;
    }

    /* Horizontal row for bottom-aligned elements */
    .track-success-row {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 32px;
    }

    .track-success-name {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 700;
      color: #8b5cf6;
      margin: 0;
      padding: 12px 24px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      display: inline-block;
    }

    .track-success-thumbnail {
      width: 280px;
      height: auto;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      margin: 0;
    }

    .track-success-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px 48px;
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 20px var(--accent-glow);
      transition: all 0.3s ease;
    }

    .track-success-btn:hover {
      background: #ff5555;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 30px var(--accent-glow);
    }

    /* Confetti particles */
    .track-success-confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      animation: confetti-fall 3s ease forwards;
      pointer-events: none;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* =========================================
       TRACK BUILDER STYLES
       ========================================= */
    .track-builder-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-dark);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }

    .track-builder-overlay.hidden {
      display: none;
    }

    .track-builder-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    /* Header */
    .tb-header {
      height: 64px;
      background: rgba(10, 10, 12, 0.95);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      padding-right: 80px;
      /* Space for close btn */
      z-index: 10;
    }

    .tb-header-left,
    .tb-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .tb-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tb-logo-icon {
      font-size: 24px;
    }

    .tb-logo-text {
      display: flex;
      flex-direction: column;
    }

    .tb-logo-title {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 1px;
      color: var(--text-muted);
    }

    .tb-track-name-input {
      background: transparent;
      border: none;
      color: white;
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 700;
      width: 200px;
      padding: 0;
    }

    .tb-track-name-input:focus {
      outline: none;
      border-bottom: 1px solid var(--accent);
    }

    /* Header Buttons */
    .tb-icon-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tb-icon-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
    }

    .tb-icon-btn.tb-danger:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }

    .tb-bake-btn {
      background: var(--accent);
      color: white;
      border: none;
      height: 40px;
      padding: 0 20px;
      border-radius: 4px;
      font-family: var(--font-display);
      font-weight: 700;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      clip-path: polygon(10px 0, 100% 0, 100% 100%, 0% 100%);
      transition: all 0.2s;
    }

    .tb-bake-btn:hover:not(:disabled) {
      background: #ff5555;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .tb-bake-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    /* Main Area */
    .tb-main {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    .tb-canvas-area {
      flex: 1;
      background: #0a1628;
      position: relative;
      overflow: hidden;
    }

    .tb-canvas {
      display: block;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Circuit Status */
    .tb-circuit-status {
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid #10b981;
      color: #10b981;
      padding: 8px 16px;
      border-radius: 20px;
      font-family: var(--font-display);
      font-weight: 700;
      letter-spacing: 1px;
      backdrop-filter: blur(8px);
      pointer-events: none;
      animation: slideDown 0.3s ease-out;
    }

    /* ERROR STATE for status */
    .tb-circuit-status.error {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    @keyframes slideDown {
      from {
        transform: translate(-50%, -20px);
        opacity: 0;
      }

      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    /* Toolbar */
    .tb-toolbar {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(19, 19, 23, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      display: flex;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .tb-tool-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      gap: 4px;
      min-width: 64px;
      transition: all 0.2s;
    }

    .tb-tool-btn span {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .tb-tool-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .tb-tool-btn.active {
      background: var(--accent);
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    /* Panel Toggle */
    .tb-panel-toggle {
      position: absolute;
      right: 320px;
      top: 50%;
      background: var(--bg-panel);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-right: none;
      width: 24px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 8px 0 0 8px;
      z-index: 20;
      transition: right 0.3s ease;
      color: var(--text-muted);
    }

    .tb-panel-toggle.collapsed {
      right: 0;
    }

    /* Properties Panel */
    .tb-properties-panel {
      width: 320px;
      background: var(--bg-panel);
      border-left: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      z-index: 15;
      transition: transform 0.3s ease;
    }

    .tb-properties-panel.collapsed {
      transform: translateX(100%);
      display: none;
    }

    .tb-panel-header {
      padding: 20px;
      font-family: var(--font-display);
      font-weight: 700;
      letter-spacing: 1px;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .tb-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 20px;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tb-stat {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tb-stat-label {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 700;
    }

    .tb-stat-value {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .tb-stat-value small {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
      margin-left: 2px;
    }

    .tb-section {
      padding: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tb-section-header {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 1px;
    }

    .tb-surface-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
    }

    .tb-surface-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
      color: var(--text-muted);
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      text-align: left;
    }

    .tb-surface-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .tb-surface-btn.active {
      background: rgba(239, 68, 68, 0.15);
      border-color: var(--accent);
      color: white;
    }

    /* Sliders */
    .tb-slider-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
    }

    .tb-slider-value {
      color: var(--accent);
      font-family: var(--font-display);
      font-size: 16px;
    }

    .tb-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.1);
      height: 6px;
      border-radius: 3px;
      outline: none;
    }

    .tb-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .tb-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .tb-tips {
      padding: 24px;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-muted);
      opacity: 0.7;
    }

    /* Close Button */
    .tb-close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      background: #0a0a0c;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 50;
      transition: all 0.2s;
    }

    .tb-close-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: rotate(90deg);
    }

    @keyframes pulse-green-glow {
      0% {
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
        border-color: rgba(74, 222, 128, 0.5);
      }

      50% {
        box-shadow: 0 0 20px 4px rgba(74, 222, 128, 0.3);
        border-color: rgba(74, 222, 128, 1);
        transform: translateY(-2px);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
        border-color: rgba(74, 222, 128, 0.5);
      }
    }

    .card.recommended {
      animation: pulse-green-glow 3s infinite ease-in-out;
      border-color: rgba(74, 222, 128, 0.6);
    }

    /* Track Builder Card */
    .card-builder {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(139, 92, 246, 0.1));
      border-color: #8b5cf6;
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.15);
      position: relative;
      overflow: hidden;
    }

    .card-builder:hover {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.25), rgba(139, 92, 246, 0.2));
      border-color: #a78bfa;
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
      transform: translateY(-5px) scale(1.02);
      z-index: 10;
    }

    .card-builder .card-icon {
      filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.6));
      animation: float-icon 3s ease-in-out infinite;
    }

    @keyframes float-icon {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-4px);
      }
    }

    /* ===== Mobile Landscape Responsive Styles ===== */
    @media screen and (max-height: 500px) and (orientation: landscape) {

      /* Reduce header padding for more content space */
      header {
        padding: 12px 24px;
      }

      .logo {
        font-size: 28px;
      }

      /* Screen container adjustments */
      .screen {
        padding: 70px 24px 24px;
      }

      /* Wizard container - center content */
      .wizard-container {
        max-width: 100%;
        padding: 0 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Wizard header - compact and centered */
      .wizard-header {
        margin-bottom: 16px;
        gap: 12px;
        width: 100%;
        max-width: 100%;
        justify-content: flex-start;
      }

      .back-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
        flex-shrink: 0;
      }

      .wizard-title {
        font-size: 20px;
      }

      .wizard-steps {
        margin-left: auto;
      }

      .step-dot {
        width: 24px;
        height: 3px;
      }

      /* Wizard step container - center the grid */
      .wizard-step {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      /* Selection grid - centered with proper spacing */
      .selection-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        gap: 12px;
        padding: 8px 16px 80px;
        max-width: 100%;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Cards - smaller and well-spaced */
      .card {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
        min-height: 100px;
        padding: 10px 8px;
        flex-shrink: 0;
      }

      .card-icon {
        font-size: 28px;
        margin-bottom: 8px;
      }

      .card-icon img {
        width: 28px;
        height: 28px;
      }

      .card-title {
        font-size: 12px;
        margin-bottom: 4px;
        text-align: center;
        line-height: 1.2;
      }

      .card-desc {
        display: none;
      }

      .card-badge {
        top: 4px;
        right: 4px;
        font-size: 7px;
        padding: 2px 4px;
      }

      /* Track card action buttons */
      .card-actions {
        top: 4px;
        left: 4px;
        gap: 2px;
      }

      .card-action-btn {
        width: 18px;
        height: 18px;
        font-size: 9px;
      }

      /* Action bar at bottom */
      .action-bar {
        padding: 12px 24px;
      }

      .start-btn {
        padding: 12px 32px;
        font-size: 16px;
      }
    }

    /* Additional breakpoint for very small landscape screens (phones) */
    @media screen and (max-height: 420px) and (orientation: landscape) {
      header {
        padding: 8px 16px;
      }

      .logo {
        font-size: 24px;
      }

      .screen {
        padding: 56px 16px 16px;
      }

      .wizard-header {
        margin-bottom: 10px;
      }

      .wizard-title {
        font-size: 18px;
      }

      .selection-grid {
        gap: 10px;
        padding: 6px 12px 70px;
      }

      .card {
        width: 105px;
        min-width: 105px;
        max-width: 105px;
        min-height: 85px;
        padding: 8px 6px;
      }

      .card-icon {
        font-size: 24px;
        margin-bottom: 6px;
      }

      .card-icon img {
        width: 24px;
        height: 24px;
      }

      .card-title {
        font-size: 11px;
      }

      .card-badge {
        font-size: 6px;
        padding: 2px 3px;
      }
    }

    /* Slightly larger landscape screens (tablets in landscape) */
    @media screen and (min-height: 501px) and (max-height: 700px) and (orientation: landscape) {
      .wizard-container {
        max-width: 100%;
        padding: 0 24px;
      }

      .wizard-step {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .selection-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        gap: 16px;
        padding: 12px 24px 100px;
        max-width: 100%;
      }

      .card {
        width: 160px;
        min-width: 160px;
        max-width: 160px;
        min-height: 130px;
        padding: 12px;
      }

      .card-icon {
        font-size: 36px;
        margin-bottom: 12px;
      }

      .card-title {
        font-size: 16px;
      }

      .card-desc {
        font-size: 11px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-clamp: 2;
        overflow: hidden;
      }
    }
  </style>

  <script src="builtin_tracks.js"></script>
  <script src="track_builder.js"></script>
</head>

<body>
  <!-- Fullscreen Overlay (for mobile) -->
  <div id="fullscreenOverlay" style="
    position: fixed; inset: 0; z-index: 9999;
    background: linear-gradient(135deg, #0a0a0c 0%, #1a1a20 50%, #0f0f14 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: 'Rajdhani', sans-serif; color: #fff;
  ">
    <div style="font-size: 64px; margin-bottom: 24px;">ðŸŽï¸</div>
    <div
      style="font-size: 28px; font-weight: 700; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 16px;">
      Racing<span style="color: #ef4444;">Vibes</span>
    </div>
    <button id="enterFullscreenBtn" style="
      background: #ef4444; color: white; border: none;
      padding: 16px 48px; font-family: 'Rajdhani', sans-serif;
      font-size: 20px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 2px; border-radius: 8px; cursor: pointer;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
      margin-top: 24px;
    ">
      TAP TO START
    </button>
    <div style="color: #94a3b8; font-size: 14px; margin-top: 16px;">Best experienced in fullscreen</div>
  </div>

  <div class="racing-flag-bg"></div>
  <div id="app">
    <header>
      <div class="logo">Racing<span>Vibes</span></div>
      <div class="user-profile" style="display:flex; gap:10px; align-items:center;"><span
          style="font-weight:600; color:#fff;">Player 1</span>
        <div style="width:32px; height:32px; background:#333; border-radius:50%;"></div>
      </div>
    </header>
    <!-- SCREEN: MAIN MENU -->
    <div id="mainMenu" class="screen active">
      <div class="menu-grid">
        <div class="menu-item large" onclick="startFreePlay(this)">
          <div class="menu-icon">ðŸŽï¸</div>
          <div class="menu-label">Free Play</div>
        </div>
        <div class="menu-item" onclick="switchToTimeTrial(this)">
          <div class="menu-icon">â±ï¸</div>
          <div class="menu-label">Time-Trial</div>
        </div>
        <div class="menu-item locked">
          <div class="menu-icon">ðŸ†</div>
          <div class="menu-label">Career Mode</div>
        </div>
        <div class="menu-item locked">
          <div class="menu-icon">ðŸŒ</div>
          <div class="menu-label">Online Multiplayer</div>
        </div>
        <div class="menu-item" onclick="openOptions(this)">
          <div class="menu-icon">ðŸ”§</div>
          <div class="menu-label">Options</div>
        </div>
        <div class="menu-item locked">
          <div class="menu-icon">ðŸ’°</div>
          <div class="menu-label">Shop</div>
        </div>
        <div class="menu-item locked">
          <div class="menu-icon">ðŸ“Š</div>
          <div class="menu-label">Achievements</div>
        </div>
        <div class="menu-item locked">
          <div class="menu-icon">ðŸ‘</div>
          <div class="menu-label">Rate</div>
        </div>
      </div>
    </div>
    <!-- SCREEN: FREE PLAY WIZARD -->
    <div id="wizard" class="screen">
      <div class="wizard-container">
        <div class="wizard-header"><button class="back-btn" onclick="wizardBack()">â†</button>
          <div class="wizard-title" id="wizardTitle">Select Class</div>
          <div class="wizard-steps">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
            <div class="step-dot" id="dot3"></div>
            <div class="step-dot" id="dot4"></div>
          </div>
        </div>
        <!-- Step 1: Class -->
        <div id="step1" class="wizard-step">
          <div class="selection-grid">
            <div class="card recommended" onclick="selectClass('gt', this)">
              <div class="card-badge"
                style="color:#4ade80; border:1px solid rgba(74,222,128,0.3); background:rgba(74,222,128,0.1);">Optimized
                âœ…</div>
              <div class="card-icon"><img src="assets/icons/Clipper_icon.png" alt="GT Class"></div>
              <div class="card-title">GT Class</div>
              <div class="card-desc">High performance touring cars. Excellent grip and acceleration.</div>
            </div>
            <div class="card recommended" onclick="selectClass('truck', this)">
              <div class="card-badge"
                style="color:#4ade80; border:1px solid rgba(74,222,128,0.3); background:rgba(74,222,128,0.1);">Optimized
                âœ…</div>
              <div class="card-icon"><img src="assets/icons/Beast.png" alt="Truck Class"></div>
              <div class="card-title">Truck Class</div>
              <div class="card-desc">Heavy metal behemoths. High torque and intimidation factor.</div>
            </div>
            <div class="card" onclick="selectClass('openwheel', this)">
              <div class="card-badge"
                style="color:#fb923c; border:1px solid rgba(251,146,60,0.3); background:rgba(251,146,60,0.1);">WIP âš ï¸
              </div>
              <div class="card-icon">ðŸŽï¸</div>
              <div class="card-title">Formula Class</div>
              <div class="card-desc">The pinnacle of speed. Extreme downforce and lightning fast reactions
                required. </div>
            </div>
            <div class="card" onclick="selectClass('rally', this)">
              <div class="card-badge"
                style="color:#fb923c; border:1px solid rgba(251,146,60,0.3); background:rgba(251,146,60,0.1);">WIP âš ï¸
              </div>
              <div class="card-icon">ðŸš™</div>
              <div class="card-title">Rally Class</div>
              <div class="card-desc">Loose surface specialists. Slide into corners and master the drift.</div>
            </div>
            <div class="card" onclick="selectClass('bubble', this)">
              <div class="card-badge"
                style="color:#fb923c; border:1px solid rgba(251,146,60,0.3); background:rgba(251,146,60,0.1);">WIP âš ï¸
              </div>
              <div class="card-icon"><img src="assets/icons/Bubble_Icon.png" alt="Bubble Class"></div>
              <div class="card-title">Bubble Class</div>
              <div class="card-desc">Fun bubbly racing. Physics that bounce and float.</div>
            </div>
            <div class="card" onclick="selectClass('grip', this)">
              <div class="card-badge"
                style="color:#ef4444; border:1px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.1);">Not
                Optimised &#9888;&#xFE0E;</div>
              <div class="card-icon">ðŸ†</div>
              <div class="card-title">Mixed (for development)</div>
              <div class="card-desc">Standard mixed racing. Features a balance of speed and handling. Perfect for
                development.</div>
            </div>
          </div>
        </div>
        <!-- Step 2: Vehicle -->
        <div id="step2" class="wizard-step hidden">
          <div class="selection-grid" id="vehicleGrid">
            <!-- Populated by JS -->
          </div>
        </div>
        <!-- Step 3: Track -->
        <div id="step3" class="wizard-step hidden">
          <div class="selection-grid" id="trackGrid">
            <!-- Populated by JS -->
          </div>
        </div>
        <!-- Step 4: Settings -->
        <div id="step4" class="wizard-step hidden">
          <div class="settings-form">
            <div class="form-group" id="grpDifficulty"><label class="form-label">AI Difficulty</label>
              <div class="range-wrap"><input type="range" min="0" max="3" step="1" value="2" id="difficultyInp"
                  oninput="updateDiff(this.value)">
                <div class="range-val" id="difficultyVal">Pro</div>
              </div>
            </div>
            <div class="form-group" id="grpLaps"><label class="form-label">Number of Laps</label>
              <div class="range-wrap"><input type="range" min="1" max="50" step="1" value="3" id="lapsInp"
                  oninput="updateVal('lapsVal', this.value)">
                <div class="range-val" id="lapsVal">3</div>
              </div>
            </div>
            <div class="form-group" id="grpBots"><label class="form-label">Number of Vehicles</label>
              <div class="range-wrap"><input type="range" min="1" max="20" step="1" value="4" id="botsInp"
                  oninput="updateVal('botsVal', this.value)">
                <div class="range-val" id="botsVal">4</div>
              </div>
            </div>
            <div class="form-group" id="grpGrid"><label class="form-label">Grid Position</label>
              <div class="range-wrap"><input type="range" min="1" max="20" step="1" value="4" id="gridInp"
                  oninput="updateVal('gridVal', this.value)">
                <div class="range-val" id="gridVal">4</div>
              </div>
            </div>
            <!-- Other toggles -->
            <div class="form-group"><label class="form-label">Game Options</label>
              <div style="display:flex; gap:20px; flex-direction: column;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                  <span>Sound Effects</span>
                  <input type="checkbox" id="sfxToggle" checked style="width:20px; height:20px;">
                </label>
                <label id="ghostToggleLbl" style="display:none; align-items:center; gap:8px; cursor:pointer;">
                  <span>Ghost</span>
                  <input type="checkbox" id="ghostToggle" checked style="width:20px; height:20px;">
                </label>
              </div>
            </div>
          </div>
        </div>
        <!-- Action Bar -->
        <div class="action-bar hidden" id="actionBar"><button class="start-btn" onclick="wizardNext()" id="nextBtn">Next
            Steps &rarr;
          </button></div>
      </div>
    </div>
    <!-- SCREEN: OPTIONS -->
    <div id="optionsScreen" class="screen">
      <div class="wizard-container">
        <div class="wizard-header"><button class="back-btn" onclick="closeOptions()">â†</button>
          <div class="wizard-title">Global Settings</div>
        </div>
        <div class="settings-form" style="max-width:800px; margin:0 auto; width:100%;">
          <!-- Master Volume -->
          <div class="form-group"><label class="form-label">Master Volume</label>
            <div class="range-wrap"><input type="range" min="0" max="100" step="1" id="optVolume"
                oninput="updateOptVol(this.value)">
              <div class="range-val" id="optVolumeVal">100%</div>
            </div>
          </div>
          <!-- Controls -->
          <div class="form-group"><label class="form-label">Control Mode</label>
            <div style="display:flex; gap:20px;">
              <div class="menu-item" id="btnTouchOpt" onclick="setOptMode('touch')" style="height:120px; flex:1;">
                <div class="menu-icon" style="font-size:32px; margin-bottom:10px;">ðŸ“±</div>
                <div class="menu-label" style="font-size:18px;">Touch</div>
              </div>
              <div class="menu-item" id="btnTiltOpt" onclick="setOptMode('tilt')" style="height:120px; flex:1;">
                <div class="menu-icon" style="font-size:32px; margin-bottom:10px;">ðŸ”„</div>
                <div class="menu-label" style="font-size:18px;">Tilt</div>
              </div>
              <div class="menu-item" id="btnSmoothOpt" onclick="setOptMode('smooth')" style="height:120px; flex:1;">
                <div class="menu-icon" style="font-size:32px; margin-bottom:10px;">ðŸŽšï¸</div>
                <div class="menu-label" style="font-size:18px;">Smooth</div>
              </div>
            </div>
            <div style="margin-top:10px; font-size:14px; opacity:0.6; text-align:center;">"Touch" enables
              on-screen buttons.<br>"Tilt" enables gyroscope steering.<br>"Smooth" enables analog slider controls.</div>
          </div>

          <!-- Toggles -->
          <div class="form-group"><label class="form-label">Game Settings</label>
            <div
              style="background:var(--bg-card); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
              <label
                style="display:flex; align-items:center; justify-content:space-between; cursor:pointer; padding:10px 0;"><span
                  style="font-size:18px; font-weight:600;">Sound Effects</span><input type="checkbox" id="optSfx"
                  onchange="setOptSfx(this.checked)"
                  style="width:24px; height:24px; accent-color:var(--accent);"></label>
            </div>
          </div>
          <!-- Graphics Quality -->
          <div class="form-group"><label class="form-label">Graphics Quality</label>
            <div style="display:flex; gap:20px;">
              <div class="menu-item" id="btnQualityHigh" onclick="setGraphicsQuality('high')"
                style="height:80px; flex:1;">
                <div class="menu-label" style="font-size:18px;">High</div>
              </div>
              <div class="menu-item" id="btnQualityMedium" onclick="setGraphicsQuality('medium')"
                style="height:80px; flex:1;">
                <div class="menu-label" style="font-size:18px;">Medium</div>
              </div>
              <div class="menu-item" id="btnQualityLow" onclick="setGraphicsQuality('low')"
                style="height:80px; flex:1;">
                <div class="menu-label" style="font-size:18px;">Low</div>
              </div>
            </div>
            <div style="margin-top:10px; font-size:14px; opacity:0.6; text-align:center;">Lower quality improves
              performance on mobile devices.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script> // ===== STATE =====

    const state = {

      step: 0,
      mode: null, // Vehicle class
      gameMode: 'race', // 'race' or 'time_trial'
      vehicle: null,
      track: null,
      config: {
        laps: 3,
        difficulty: 2, // 0=Easy, 1=Normal, 2=Hard, 3=Pro
        botCount: 4,
        gridPos: 4
      }
    }

      ;

    // ===== DATA =====
    const VEHICLES = [{
      id: 'GT', name: 'GT Spec', class: 'gt', icon: '<img src="assets/icons/Clipper_icon.png" alt="GT Spec">'
    }

      ,
    {
      id: 'F1', name: 'Formula X', class: 'openwheel', icon: 'ðŸŽï¸'
    }

      ,
    {
      id: 'Rally', name: 'Rally Cross', class: 'rally', icon: 'ðŸš™'
    }

      ,
    {
      id: 'Truck', name: 'Super Truck', class: 'truck', icon: '<img src="assets/icons/Beast.png" alt="Super Truck">'
    }

      ,
    {
      id: 'Bubble', name: 'Bubble Car', class: 'bubble', icon: '<img src="assets/icons/Bubble_Icon.png" alt="Bubble Car">'
    }

    ];

    // Default tracks
    const BUILTIN_TRACKS = [{
      id: 'Test', name: 'Test Circuit', desc: 'Perfect for shakedowns and learning.'
    }

      ,
    {
      id: 'Sharp_Corners', name: 'Sharp Corners', desc: 'Technical hairpin madness.'
    }

      ,
    {
      id: 'Bendy_Vibes', name: 'Bendy Vibes', desc: 'Flowing curves and sweeping bends.'
    }

    ];

    // ===== UI NAVIGATION =====

    function startFreePlay(el) {
      if (el) highlightMenu(el);
      setTimeout(() => {
        state.gameMode = 'race';
        state.config.botCount = 4;
        state.config.gridPos = 4;
        state.config.laps = 3;

        const setVal = (id, val, logicId) => {
          const el = document.getElementById(id);
          if (el) el.value = val;
          updateVal(logicId, val);
        };

        setVal('botsInp', 4, 'botsVal');
        setVal('gridInp', 4, 'gridVal');
        setVal('lapsInp', 3, 'lapsVal');

        startWizard();
      }, 200);
    }

    function startWizard() {
      switchScreen('wizard');
      setStep(1);
    }

    function switchToTimeTrial(el) {
      if (el) highlightMenu(el);
      setTimeout(() => {
        state.gameMode = 'time_trial';
        // Preset logic
        if (state.config.botCount > 0) state.config.botCount = 0;
        startWizard();
      }, 200);
    }

    function switchScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // Clear main menu selection on return
      if (id === 'mainMenu') {
        const items = document.querySelectorAll('#mainMenu .menu-item');
        items.forEach(el => el.classList.remove('selected'));
      }
    }

    function setStep(n) {
      state.step = n;

      // Update dots
      for (let i = 1; i <= 4; i++) {
        const d = document.getElementById('dot' + i);
        d.className = 'step-dot ' + (i === n ? 'active' : (i < n ? 'done' : ''));
      }

      // Hide all steps
      document.querySelectorAll('.wizard-step').forEach(s => s.classList.add('hidden'));

      // Show current
      document.getElementById('step' + n).classList.remove('hidden');

      // Update Title and Next Button
      const title = document.getElementById('wizardTitle');
      const nextBtn = document.getElementById('nextBtn');
      const bar = document.getElementById('actionBar');

      bar.classList.add('hidden');

      if (n === 1) {
        title.textContent = "Select Class";
        // Clear selection on revisit
        state.mode = null;
        const step1Cards = document.querySelectorAll('#step1 .card');
        step1Cards.forEach(c => c.classList.remove('selected'));
      }

      else if (n === 2) {
        title.textContent = "Select Vehicle";
        state.vehicle = null; // Clear prev selection
        renderVehicles();
      }

      else if (n === 3) {
        title.textContent = "Select Track";
        state.track = null; // Clear prev selection
        renderTracks();
      }

      else if (n === 4) {
        title.textContent = "Race Settings";
        bar.classList.remove('hidden');
        nextBtn.innerHTML = "START RACE ðŸ";

        // TIME TRIAL LOGIC
        const isTimeTrial = state.gameMode === 'time_trial';

        // Helper to toggle visibility
        const show = (id, visible) => {
          const el = document.getElementById(id);
          if (el) el.style.display = visible ? 'block' : 'none';
        };

        show('grpDifficulty', !isTimeTrial);
        show('grpBots', !isTimeTrial);
        show('grpGrid', !isTimeTrial);

        // Ghost Toggle (flex for alignment)
        const ghost = document.getElementById('ghostToggleLbl');
        if (ghost) ghost.style.display = isTimeTrial ? 'flex' : 'none';

        // Laps logic
        if (isTimeTrial) {
          state.config.laps = 50;
          const lapsInp = document.getElementById('lapsInp');
          if (lapsInp) lapsInp.value = 50;
          updateVal('lapsVal', 50);
        } else {
          // ensure difficulty reset for Race mode
          state.config.difficulty = 2;
          const diffInp = document.getElementById('difficultyInp');
          if (diffInp) {
            diffInp.value = 2;
            updateDiff(2);
          }
        }

        // Sync toggles with global settings
        const sfx = localStorage.getItem('sfxEnabled') !== 'false';
        document.getElementById('sfxToggle').checked = sfx;
      }
    }

    function wizardNext() {
      if (state.step < 4) {
        setStep(state.step + 1);
      }

      else {
        launchGame();
      }
    }

    function wizardBack() {
      if (state.step > 1) {
        setStep(state.step - 1);
      }

      else {
        switchScreen('mainMenu');
      }
    }

    // ===== SELECTION LOGIC =====

    function selectClass(cls, el) {
      state.mode = cls;
      highlightCard(el);
      setTimeout(wizardNext, 200); // Small delay for visual feedback
    }

    function selectVehicle(vid, el) {
      state.vehicle = vid;
      highlightCard(el);
      setTimeout(wizardNext, 200);
    }

    function selectTrack(tid, el) {
      state.track = tid;
      highlightCard(el);
      setTimeout(wizardNext, 200);
    }

    function highlightCard(el) {
      // clear siblings
      const sibling = el.parentNode.querySelectorAll('.card');
      sibling.forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    function highlightMenu(el) {
      // clear siblings
      const sibling = el.parentNode.querySelectorAll('.menu-item');
      sibling.forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    // ===== RENDERING =====

    function renderVehicles() {
      const grid = document.getElementById('vehicleGrid');
      grid.innerHTML = '';

      // Filter vehicles based on selected class
      const filtered = state.mode === 'grip' ? VEHICLES : VEHICLES.filter(v => v.class === state.mode);

      filtered.forEach(v => {
        const div = document.createElement('div');

        div.className = `card ${state.vehicle === v.id ? 'selected' : ''}`;
        if (v.id === 'GT') {
          div.className += ' recommended';
        }
        div.onclick = () => selectVehicle(v.id, div);

        const badge = v.id === 'GT' ? `<div class="card-badge" style="color:#4ade80; border:1px solid rgba(74,222,128,0.3); background:rgba(74,222,128,0.1);">Optimized âœ…</div>` : '';

        div.innerHTML = ` 
          ${badge}
          <div class="card-icon">${v.icon}</div> 
          <div class="card-title">${v.name}</div> 
          <div class="card-desc">Class: ${v.class.toUpperCase()}</div> 
        `;
        grid.appendChild(div);
      });
    }

    function openTrackBuilder() {
      if (typeof TrackBuilder === 'undefined' || !TrackBuilder.create) {
        console.warn('TrackBuilder not available');
        return;
      }
      TrackBuilder.create({
        onSaved: (track) => {
          renderTracks();
        },
        onTestDrive: (_m, entry) => {
          state.track = 'custom:' + entry.id;
          launchGame();
        },
        onClose: () => { }
      }).open();
    }

    async function renderTracks() {
      const grid = document.getElementById('trackGrid');
      grid.innerHTML = '';



      // Built-ins
      // Custom sort: Bendy_Vibes first
      const allKeys = Object.keys(window.BUILTIN_TRACKS || {});
      const trackKeys = allKeys.sort((a, b) => (a === 'Bendy_Vibes' ? -1 : (b === 'Bendy_Vibes' ? 1 : 0)));

      const promises = trackKeys.map(async key => {
        const t = window.BUILTIN_TRACKS[key];
        const div = document.createElement('div');

        // Use the same ID logic as racer.html expects (key)
        const trackId = key;

        div.className = `card ${state.track === trackId ? 'selected' : ''}`;

        // Add recommended style to Test and Bendy Vibes
        if (trackId === 'Test' || trackId === 'Bendy_Vibes') {
          div.className += ' recommended';
        }

        div.onclick = () => selectTrack(trackId, div);

        let badge = '';
        if (trackId === 'Test' || trackId === 'Bendy_Vibes') {
          badge = `<div class="card-badge" style="color:#4ade80; border:1px solid rgba(74,222,128,0.3); background:rgba(74,222,128,0.1);">Optimized âœ…</div>`;
        } else if (trackId === 'Sharp_Corners') {
          badge = `<div class="card-badge" style="color:#ef4444; border:1px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.1);">Difficult âš ï¸</div>`;
        }

        // Generate Thumbnail
        let thumbUrl = '';
        try {
          if (window.TrackBuilder && TrackBuilder.makeThumbnail) {
            // Calculate visual width (default scale 2.5x) to match game appearance
            const visualWidth = (t.roadWidth || 120) * 2.5;
            const thumb = await TrackBuilder.makeThumbnail(t.points, t.world.width, t.world.height, visualWidth);
            thumbUrl = thumb.pngData;
          }
        } catch (e) {
          console.warn('Thumbnail gen failed for', t.name, e);
        }

        const iconHtml = thumbUrl
          ? `<div class="card-thumbnail" style="background-image: url('${thumbUrl}')"></div>`
          : `<div class="card-icon" >ðŸ</div>`;

        // We want the icon/thumb to be the main visual
        div.innerHTML = ` 
          ${badge}
          ${iconHtml}
          <div class="card-title" >${t.name}</div> 
          <div class="card-desc" >Custom built-in</div> 
          `;
        return div;
      });

      const builtInCards = await Promise.all(promises);
      builtInCards.forEach(div => grid.appendChild(div));

      // Custom tracks (from storage)
      if (window.TrackStore) {
        try {
          const customs = await TrackStore.listTracks();

          customs.forEach(t => {
            const tid = 'custom:' + t.id;
            const div = document.createElement('div');

            // Add card-new-track class for purple pulsing outline on new tracks
            const newTrackClass = t.isNew ? 'card-new-track' : '';
            div.className = `card ${newTrackClass} ${state.track === tid ? 'selected' : ''}`.trim();
            div.style.position = 'relative'; // For absolute positioning of badges
            div.onclick = () => selectTrack(tid, div);

            // Show "New" badge if track hasn't been raced yet
            const newBadge = t.isNew ? '<span class="card-badge-new">New</span>' : '';

            // Action buttons for custom tracks
            const actionButtons = `
              <div class="card-actions">
                <button class="card-action-btn export" title="Export" onclick="handleExportTrack('${t.id}', event)">ðŸ“¤</button>
                <button class="card-action-btn rename" title="Rename" onclick="handleRenameTrack('${t.id}', '${t.name.replace(/'/g, "\\'")}', event)">âœï¸</button>
                <button class="card-action-btn delete" title="Delete" onclick="handleDeleteTrack('${t.id}', '${t.name.replace(/'/g, "\\'")}', event)">ðŸ—‘ï¸</button>
              </div>
            `;

            // Use stored thumbnail if available
            // Note: track_storage.js stores thumbnail object with pngData
            const thumbUrl = (t.thumbnail && t.thumbnail.pngData) ? t.thumbnail.pngData : '';
            const iconHtml = thumbUrl
              ? `<div class="card-thumbnail" style="background-image: url('${thumbUrl}')"></div>`
              : `<div class="card-icon" >â­</div>`;

            div.innerHTML = `${newBadge}<span class="card-badge">Custom</span>${iconHtml}<div class="card-title">${t.name}</div><div class="card-desc">User created track</div>${actionButtons}`;
            grid.appendChild(div);
          });
        }

        catch (e) {
          console.error(e);
        }
      }

      // ==> Track Builder Button
      const builderDiv = document.createElement('div');
      builderDiv.className = 'card card-builder';
      builderDiv.onclick = openTrackBuilder;
      builderDiv.innerHTML = `
        <div class="card-icon">âœï¸</div>
        <div class="card-title">Draw your Experience</div>
        <div class="card-desc">Use your imagination to draw your own racing track.</div>
      `;
      grid.appendChild(builderDiv);
    }

    // ===== TRACK MANAGEMENT HANDLERS =====

    async function handleExportTrack(trackId, event) {
      event.stopPropagation(); // Prevent card selection
      if (!window.TrackStore || !TrackStore.exportAsBuiltin) {
        alert('Export functionality not available.');
        return;
      }
      try {
        await TrackStore.exportAsBuiltin(trackId);
      } catch (e) {
        console.error('Failed to export track:', e);
        alert('Failed to export track. See console for details.');
      }
    }

    async function handleRenameTrack(trackId, currentName, event) {
      event.stopPropagation(); // Prevent card selection
      const newName = prompt('Enter new track name:', currentName);
      if (!newName || newName.trim() === '' || newName === currentName) {
        return; // User cancelled or name unchanged
      }
      if (!window.TrackStore) {
        alert('Track storage not available.');
        return;
      }
      try {
        const track = await TrackStore.getTrack(trackId);
        if (!track) {
          alert('Track not found.');
          return;
        }
        track.name = newName.trim();
        await TrackStore.saveTrack(track);
        renderTracks(); // Refresh the track list
      } catch (e) {
        console.error('Failed to rename track:', e);
        alert('Failed to rename track. See console for details.');
      }
    }

    async function handleDeleteTrack(trackId, trackName, event) {
      event.stopPropagation(); // Prevent card selection
      const confirmed = confirm(`Are you sure you want to delete "${trackName}"?\n\nThis action cannot be undone.`);
      if (!confirmed) {
        return;
      }
      if (!window.TrackStore) {
        alert('Track storage not available.');
        return;
      }
      try {
        await TrackStore.deleteTrack(trackId);
        // Clear selection if deleted track was selected
        if (state.track === 'custom:' + trackId) {
          state.track = null;
        }
        renderTracks(); // Refresh the track list
      } catch (e) {
        console.error('Failed to delete track:', e);
        alert('Failed to delete track. See console for details.');
      }
    }

    // ===== SETTINGS UTILS =====

    function updateVal(id, val) {
      document.getElementById(id).textContent = val;
      if (id === 'lapsVal') state.config.laps = parseInt(val);
      if (id === 'botsVal') state.config.botCount = parseInt(val);
      if (id === 'gridVal') state.config.gridPos = parseInt(val);
    }

    function updateDiff(val) {
      const v = parseInt(val);
      state.config.difficulty = v;
      const labels = ['Walk in the park',
        'Casual',
        'Pro',
        'Realistic'];
      document.getElementById('difficultyVal').textContent = labels[v] || 'Normal';
    }



    // ===== LAUNCH =====

    async function launchGame() {

      // Save Config to Session
      const ghostToggleEl = document.getElementById('ghostToggle');
      // Ghost is only enabled in Time Trial mode when the checkbox is checked
      const ghostEnabled = state.gameMode === 'time_trial' && ghostToggleEl ? ghostToggleEl.checked : false;
      const payload = {
        mode: state.mode,
        car: state.vehicle,
        track: state.track,
        laps: state.config.laps,
        difficulty: state.config.difficulty, // 0-3
        botCount: state.config.botCount,
        gridPos: state.config.gridPos,
        ghostEnabled: ghostEnabled
      };

      // Also save settings to localStorage
      const sfx = document.getElementById('sfxToggle').checked;
      localStorage.setItem('sfxEnabled', sfx);

      // Mark custom track as raced (remove "New" badge)
      if (state.track && state.track.startsWith('custom:') && window.TrackStore) {
        const trackId = state.track.replace('custom:', '');
        try {
          const track = await TrackStore.getTrack(trackId);
          if (track && track.isNew) {
            track.isNew = false;
            await TrackStore.saveTrack(track);
          }
        } catch (e) {
          console.error('Failed to mark track as raced:', e);
        }
      }

      // Helper to save payload
      saveStartPayload(payload);

      // Go!
      window.location.href = 'racer.html';
    }

    // Copy of original helper
    function saveStartPayload(payload) {
      if (!payload) return;
      let json = JSON.stringify(payload);

      try {
        sessionStorage.setItem('RacingVibesStartPayload', json);
        window.name = 'RacingVibesStart:' + json;
      }

      catch (_) { }
    }

    // ===== OPTIONS MENU LOGIC =====

    function openOptions(el) {
      if (el) highlightMenu(el);
      setTimeout(() => {
        switchScreen('optionsScreen');

        // Load Volume
        const vol = localStorage.getItem('masterVolume');
        const vVal = vol === null ? 70 : Math.round(parseFloat(vol) * 100);
        document.getElementById('optVolume').value = vVal;
        document.getElementById('optVolumeVal').textContent = vVal + '%';

        // Load Controls (Touch vs Tilt vs Smooth)
        // "Touch" = steeringMode:touch, gyro:false
        // "Tilt" = steeringMode:touch, gyro:true
        // "Smooth" = steeringMode:smooth
        const steeringMode = localStorage.getItem('steeringMode');
        const gyro = localStorage.getItem('gyroSteeringEnabled') === 'true';
        if (steeringMode === 'smooth') {
          setOptModeUI('smooth');
        } else {
          setOptModeUI(gyro ? 'tilt' : 'touch');
        }

        // Load SFX (default to true if null)
        const sfx = localStorage.getItem('sfxEnabled') !== 'false';
        document.getElementById('optSfx').checked = sfx;

        // Load Graphics Quality (default to 'low')
        const graphicsQuality = localStorage.getItem('graphicsQuality') || 'low';
        updateGraphicsQualityUI(graphicsQuality);
      }, 200);
    }

    function closeOptions() {
      switchScreen('mainMenu');
    }

    function updateOptVol(val) {
      document.getElementById('optVolumeVal').textContent = val + '%';
      localStorage.setItem('masterVolume', (parseInt(val) / 100).toFixed(2));
    }

    function setOptMode(mode) {
      if (mode === 'touch') {
        localStorage.setItem('steeringMode', 'touch');
        localStorage.setItem('gyroSteeringEnabled', 'false');
      } else if (mode === 'tilt') {
        localStorage.setItem('steeringMode', 'touch');
        localStorage.setItem('gyroSteeringEnabled', 'true');
      } else if (mode === 'smooth') {
        localStorage.setItem('steeringMode', 'smooth');
        localStorage.setItem('gyroSteeringEnabled', 'false');
      }
      setOptModeUI(mode);
    }

    function setOptModeUI(mode) {
      const btnTouch = document.getElementById('btnTouchOpt');
      const btnTilt = document.getElementById('btnTiltOpt');
      const btnSmooth = document.getElementById('btnSmoothOpt');

      const setStyle = (btn, active) => {
        if (!btn) return;
        btn.style.borderColor = active ? 'var(--accent)' : 'rgba(255,255,255,0.05)';
        btn.style.background = active ? 'rgba(239,68,68,0.1)' : 'linear-gradient(160deg, #2a2a30, #16161a)';
      };

      setStyle(btnTouch, mode === 'touch');
      setStyle(btnTilt, mode === 'tilt');
      setStyle(btnSmooth, mode === 'smooth');
    }

    function setOptSfx(checked) {
      localStorage.setItem('sfxEnabled', checked);
    }

    function setGraphicsQuality(quality) {
      localStorage.setItem('graphicsQuality', quality);
      updateGraphicsQualityUI(quality);
    }

    function updateGraphicsQualityUI(quality) {
      const btnHigh = document.getElementById('btnQualityHigh');
      const btnMedium = document.getElementById('btnQualityMedium');
      const btnLow = document.getElementById('btnQualityLow');

      const setStyle = (btn, active) => {
        if (!btn) return;
        btn.style.borderColor = active ? 'var(--accent)' : 'rgba(255,255,255,0.05)';
        btn.style.background = active ? 'rgba(239,68,68,0.1)' : 'linear-gradient(160deg, #2a2a30, #16161a)';
      };

      setStyle(btnHigh, quality === 'high');
      setStyle(btnMedium, quality === 'medium');
      setStyle(btnLow, quality === 'low');
    }

    // ===== FULLSCREEN UTILITY =====
    // Request fullscreen politely (same as racer.html)
    function requestFullscreen(el) {
      if (!el) return;
      const anyEl = el;
      try {
        if (anyEl.requestFullscreen) return anyEl.requestFullscreen();
        if (anyEl.webkitRequestFullscreen) return anyEl.webkitRequestFullscreen();
        if (anyEl.msRequestFullscreen) return anyEl.msRequestFullscreen();
      } catch (e) { /* ignore */ }
    }

    // Attempt fullscreen upon first user interaction via the overlay button
    // Chrome Android requires a direct button click for fullscreen to work reliably
    const overlay = document.getElementById('fullscreenOverlay');
    const fsBtn = document.getElementById('enterFullscreenBtn');

    function enterFullscreenAndStart() {
      requestFullscreen(document.documentElement);
      // Mark that fullscreen was requested so racer.html can re-request if needed
      try { sessionStorage.setItem('RacingVibesFullscreenRequested', '1'); } catch (_) { }
      // Hide the overlay
      if (overlay) overlay.style.display = 'none';
    }

    // Handle button click
    if (fsBtn) {
      fsBtn.addEventListener('click', enterFullscreenAndStart);
    }

    // On desktop, also allow clicking anywhere on the overlay
    if (overlay) {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          enterFullscreenAndStart();
        }
      });
    }



  </script>
</body>

</html>