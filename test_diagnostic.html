<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comprehensive Gear Slider Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .log {
            background: #2d2d2d;
            padding: 20px;
            margin: 15px 0;
            border-radius: 6px;
            max-height: 700px;
            overflow-y: auto;
        }
        .success { color: #89d185; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #9cdcfe; }
    </style>
</head>
<body>
    <h1>Comprehensive Gear Slider Diagnostic</h1>
    <p>Testing gear count slider behavior with extensive logging</p>
    <button onclick="runFullTest()">Run Full Diagnostic</button>
    <div id="log" class="log"></div>

    <script type="module">
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            el.innerHTML += `<div class="${className}">${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        window.runFullTest = async function() {
            document.getElementById('log').innerHTML = '';
            log('=== COMPREHENSIVE GEAR SLIDER DIAGNOSTIC ===', 'warning');
            
            try {
                // Load modules
                log('\n[1/6] Loading modules...', 'info');
                const script = document.createElement('script');
                script.type = 'module';
                script.src = './physics.js';
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const gearboxModule = await import('./gearbox.js');
                const { Gearbox, gearboxDefaults } = gearboxModule;
                log('✓ Physics and gearbox modules loaded', 'success');
                
                // Create car
                log('\n[2/6] Creating test car...', 'info');
                const car = {
                    kind: 'GT',
                    physics: {
                        params: {
                            wheelbase: 36,
                            cgToFront: 17,
                            cgToRear: 19,
                            mass: 2.20,
                            accelDurationMult: 5.0,
                            maxSpeed: 10000
                        },
                        a: 17,
                        b: 19,
                        Izz: 100
                    },
                    gearbox: new Gearbox({ 
                        ...gearboxDefaults, 
                        ratios: [3.54, 2.77, 2.16, 1.69, 1.32, 1.03]
                    })
                };
                
                log(`✓ Car created with ${car.gearbox.c.ratios.length} gears`);
                log(`  Initial ratios: ${car.gearbox.c.ratios.map(r => r.toFixed(2)).join(', ')}`);
                log(`  maxSpeed setting: ${car.physics.params.maxSpeed} px/s`, 'info');
                
                // Drive to reach higher gear
                log('\n[3/6] Simulating driving to reach 4th gear...', 'info');
                for (let i = 0; i < 40; i++) {
                    car.gearbox.update(0.1, { speedMps: i * 1.5, throttle: 1.0 });
                }
                const beforeGear = car.gearbox.state.gear;
                const beforeRpm = car.gearbox.state.rpm;
                const beforeSpeed = car.gearbox.state.speedMps;
                log(`✓ Car state: Gear ${beforeGear}, RPM ${Math.round(beforeRpm)}, Speed ${beforeSpeed.toFixed(1)} m/s`, 'success');
                
                // Calculate what ratios SHOULD be
                log('\n[4/6] Analyzing gear ratio calculation...', 'info');
                window.RacerPhysics.defaults.GT.gearCount = 4;
                const base = window.RacerPhysics.defaults.GT;
                const maxSpeedPxPerSec = base.maxSpeed != null ? base.maxSpeed : 10000;
                const targetTopSpeedMps = maxSpeedPxPerSec / 30;
                
                log(`  maxSpeed from defaults: ${maxSpeedPxPerSec} px/s`);
                log(`  Converted to m/s: ${targetTopSpeedMps.toFixed(2)} m/s`, 'info');
                log(`  Current car speed: ${beforeSpeed.toFixed(1)} m/s`, 'info');
                
                const suggestGearRatios = gearboxModule.suggestGearRatios;
                const GEARBOX_CONFIG = gearboxModule.GEARBOX_CONFIG;
                
                const calculatedRatios = suggestGearRatios({
                    redlineRpm: car.gearbox.c.redlineRPM || GEARBOX_CONFIG.redlineRpm,
                    finalDrive: car.gearbox.c.finalDrive || GEARBOX_CONFIG.finalDrive,
                    tireRadiusM: car.gearbox.c.tireRadiusM || GEARBOX_CONFIG.tireRadiusM,
                    targetTopSpeedMps: targetTopSpeedMps,
                    gears: 4,
                    spacing: 1.28
                });
                
                log(`  Calculated new ratios (4 gears): ${calculatedRatios.map(r => r.toFixed(3)).join(', ')}`, 'success');
                
                // Check if these ratios can handle current speed
                const finalDrive = car.gearbox.c.finalDrive || GEARBOX_CONFIG.finalDrive;
                const tireRadiusM = car.gearbox.c.tireRadiusM || GEARBOX_CONFIG.tireRadiusM;
                const redlineRpm = car.gearbox.c.redlineRPM || GEARBOX_CONFIG.redlineRpm;
                
                log('\n  Testing if new ratios can handle current speed:', 'warning');
                calculatedRatios.forEach((ratio, i) => {
                    // Calculate RPM at current speed in this gear
                    const totalRatio = Math.abs(ratio * finalDrive);
                    const wheelSpeedRadPerSec = beforeSpeed / tireRadiusM;
                    const engineRpm = (wheelSpeedRadPerSec * 60) / (2 * Math.PI) * totalRatio;
                    const overRedline = engineRpm > redlineRpm;
                    log(`    Gear ${i+1}: ${engineRpm.toFixed(0)} RPM ${overRedline ? '❌ OVER REDLINE!' : '✓'}`, overRedline ? 'error' : 'success');
                });
                
                // Apply the change
                log('\n[5/6] Applying gear count change (6 → 4)...', 'info');
                car.gearbox.c.ratios = calculatedRatios;
                car.gearbox.state.gearRatios = calculatedRatios;
                car.gearbox.state.maxGear = calculatedRatios.length;
                
                log('  Before refreshFromConfig():');
                log(`    Gear: ${car.gearbox.state.gear}, RPM: ${Math.round(car.gearbox.state.rpm)}`);
                
                car.gearbox.refreshFromConfig();
                
                const afterGear = car.gearbox.state.gear;
                const afterRpm = car.gearbox.state.rpm;
                const afterSpeed = car.gearbox.state.speedMps;
                
                log('  After refreshFromConfig():');
                log(`    Gear: ${afterGear}, RPM: ${Math.round(afterRpm)}, Speed: ${afterSpeed.toFixed(1)} m/s`);
                
                // Test continued driving
                log('\n[6/6] Testing continued driving...', 'info');
                const driveLog = [];
                for (let i = 0; i < 25; i++) {
                    const speed = afterSpeed + i * 3;
                    car.gearbox.update(0.1, { speedMps: speed, throttle: 1.0 });
                    if (i % 5 === 0) {
                        driveLog.push({
                            frame: i,
                            speed: speed.toFixed(1),
                            gear: car.gearbox.state.gear,
                            rpm: Math.round(car.gearbox.state.rpm)
                        });
                    }
                }
                
                driveLog.forEach(entry => {
                    log(`  Frame ${entry.frame}: ${entry.speed} m/s → Gear ${entry.gear}, ${entry.rpm} RPM`);
                });
                
                const gears = [...new Set(driveLog.map(g => g.gear))];
                log(`\n✓ Gears used: ${gears.join(', ')}`, gears.length > 1 ? 'success' : 'error');
                
                // Final verdict
                log('\n=== DIAGNOSTIC RESULTS ===', 'warning');
                if (gears.length === 1 && gears[0] === driveLog[0].gear) {
                    log('❌ PROBLEM CONFIRMED: Car stuck in same gear', 'error');
                    log('  This means the gearbox is not shifting after gear count change', 'error');
                } else if (gears.includes(1) && driveLog.every(d => d.gear === 1)) {
                    log('❌ PROBLEM CONFIRMED: Car stuck in 1st gear', 'error');
                } else {
                    log('✓ Gears shifting normally', 'success');
                }
                
                // Speed check
                const maxSpeedReached = Math.max(...driveLog.map(d => parseFloat(d.speed)));
                log(`  Max speed reached in test: ${maxSpeedReached.toFixed(1)} m/s`);
                if (maxSpeedReached < beforeSpeed) {
                    log('  ⚠️ Speed DECREASED after gear change', 'warning');
                }
                
            } catch (err) {
                log(`\n✗ Error: ${err.message}`, 'error');
                log(err.stack, 'error');
            }
        };
    </script>
</body>
</html>
