<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gear Slider Final Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .test-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .test-box h2 {
            color: #1565C0;
            margin-top: 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #89d185; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Gear Slider Final Test</h1>
        
        <div class="test-box">
            <h2>Test Scenario</h2>
            <p>This test verifies that:</p>
            <ol>
                <li>Moving the gear slider immediately updates active cars</li>
                <li>Cars continue driving smoothly (don't get stuck in 1st gear)</li>
                <li>Gear ratios recalculate to maintain top speed</li>
                <li>Current driving state (gear, RPM, speed) is preserved</li>
            </ol>
        </div>

        <button onclick="runTest()">Run Test</button>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        function log(msg, type = 'info') {
            const el = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            el.innerHTML += `<div class="${className}">${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        window.runTest = async function() {
            document.getElementById('log').innerHTML = '';
            log('=== Starting Gear Slider Test ===', 'warning');
            
            try {
                // Load physics module
                log('\n1. Loading physics module...');
                const script = document.createElement('script');
                script.type = 'module';
                script.src = './physics.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                if (!window.RacerPhysics) {
                    throw new Error('RacerPhysics not loaded');
                }
                log('âœ“ Physics module loaded', 'success');
                
                // Load gearbox module
                log('\n2. Loading gearbox module...');
                const gearboxModule = await import('./gearbox.js');
                const { Gearbox, gearboxDefaults } = gearboxModule;
                log('âœ“ Gearbox module loaded', 'success');
                
                // Create test car
                log('\n3. Creating test car with 6 gears...');
                const car = {
                    kind: 'GT',
                    physics: {
                        params: {
                            wheelbase: 36,
                            cgToFront: 17,
                            cgToRear: 19,
                            mass: 2.20,
                            accelDurationMult: 5.0,
                            maxSpeed: 10000
                        },
                        a: 17,
                        b: 19,
                        Izz: 100
                    },
                    gearbox: new Gearbox({ 
                        ...gearboxDefaults, 
                        ratios: [3.54, 2.77, 2.16, 1.69, 1.32, 1.03]
                    })
                };
                log(`âœ“ Car created with ${car.gearbox.c.ratios.length} gears`, 'success');
                log(`  Initial ratios: ${car.gearbox.c.ratios.map(r => r.toFixed(2)).join(', ')}`);
                
                // Simulate driving to get car into higher gear
                log('\n4. Simulating driving to reach 4th gear...');
                for (let i = 0; i < 40; i++) {
                    car.gearbox.update(0.1, { speedMps: i * 1.5, throttle: 1.0 });
                }
                const gearBefore = car.gearbox.state.gear;
                const rpmBefore = car.gearbox.state.rpm;
                const speedBefore = car.gearbox.state.speedMps;
                log(`âœ“ Car now in gear ${gearBefore}, RPM: ${Math.round(rpmBefore)}, Speed: ${speedBefore.toFixed(1)} m/s`, 'success');
                
                // Change gear count (simulate slider change)
                log('\n5. Changing gear count from 6 to 4 gears...');
                window.RacerPhysics.defaults.GT.gearCount = 4;
                
                // Simulate what refreshActiveCarPhysics does
                const base = window.RacerPhysics.defaults.GT;
                const gearCount = base.gearCount;
                const currentGearCount = car.gearbox.c.ratios.length;
                
                log(`  Target: ${gearCount} gears, Current: ${currentGearCount} gears`);
                log(`  Will recalculate: ${gearCount !== currentGearCount}`);
                
                if (gearCount >= 3 && gearCount <= 10 && gearCount !== currentGearCount) {
                    const suggestGearRatios = gearboxModule.suggestGearRatios;
                    const GEARBOX_CONFIG = gearboxModule.GEARBOX_CONFIG;
                    
                    const newRatios = suggestGearRatios({
                        redlineRpm: car.gearbox.c.redlineRPM || GEARBOX_CONFIG.redlineRpm,
                        finalDrive: car.gearbox.c.finalDrive || GEARBOX_CONFIG.finalDrive,
                        tireRadiusM: car.gearbox.c.tireRadiusM || GEARBOX_CONFIG.tireRadiusM,
                        targetTopSpeedMps: 54,
                        gears: gearCount,
                        spacing: 1.28
                    });
                    
                    log(`  New ratios: ${newRatios.map(r => r.toFixed(2)).join(', ')}`);
                    
                    // Save current state
                    const currentGear = car.gearbox.state.gear;
                    const currentRpm = car.gearbox.state.rpm;
                    const currentSpeed = car.gearbox.state.speedMps;
                    
                    // Update ratios
                    car.gearbox.c.ratios = newRatios;
                    car.gearbox.state.gearRatios = newRatios;
                    car.gearbox.state.maxGear = newRatios.length;
                    
                    // Clamp gear
                    const minGear = car.gearbox.state.enableReverse !== false ? -1 : 0;
                    const maxGear = newRatios.length;
                    car.gearbox.state.gear = Math.max(minGear, Math.min(maxGear, currentGear));
                    
                    // Preserve state
                    car.gearbox.state.rpm = currentRpm;
                    car.gearbox.state.smoothedRpm = currentRpm;
                    car.gearbox.state.speedMps = currentSpeed;
                    
                    car.gearbox._syncOutputs();
                    
                    log('âœ“ Ratios updated', 'success');
                }
                
                const gearAfter = car.gearbox.state.gear;
                const rpmAfter = car.gearbox.state.rpm;
                const speedAfter = car.gearbox.state.speedMps;
                
                log(`  After update: Gear ${gearAfter}, RPM: ${Math.round(rpmAfter)}, Speed: ${speedAfter.toFixed(1)} m/s`);
                
                // Verify state preserved
                log('\n6. Verifying state preservation...');
                if (Math.abs(rpmAfter - rpmBefore) < 10) {
                    log('âœ“ RPM preserved', 'success');
                } else {
                    log(`âœ— RPM changed: ${Math.round(rpmBefore)} â†’ ${Math.round(rpmAfter)}`, 'error');
                }
                
                if (Math.abs(speedAfter - speedBefore) < 0.1) {
                    log('âœ“ Speed preserved', 'success');
                } else {
                    log(`âœ— Speed changed: ${speedBefore.toFixed(1)} â†’ ${speedAfter.toFixed(1)}`, 'error');
                }
                
                if (gearAfter > 0 && gearAfter <= 4) {
                    log(`âœ“ Gear valid: ${gearAfter} (clamped from ${gearBefore})`, 'success');
                } else {
                    log(`âœ— Gear invalid: ${gearAfter}`, 'error');
                }
                
                // Continue driving
                log('\n7. Testing continued driving after gear change...');
                const gearHistory = [];
                for (let i = 0; i < 20; i++) {
                    const speed = speedBefore + i * 2;
                    car.gearbox.update(0.1, { speedMps: speed, throttle: 1.0 });
                    if (i % 5 === 0) {
                        gearHistory.push({
                            speed: speed.toFixed(1),
                            gear: car.gearbox.state.gear,
                            rpm: Math.round(car.gearbox.state.rpm)
                        });
                    }
                }
                
                const uniqueGears = [...new Set(gearHistory.map(g => g.gear))];
                log(`Gears used: ${uniqueGears.join(', ')}`);
                gearHistory.forEach(entry => {
                    log(`  Speed ${entry.speed} m/s: Gear ${entry.gear}, ${entry.rpm} RPM`);
                });
                
                if (uniqueGears.length > 1 || uniqueGears[0] !== 1) {
                    log('âœ“ Car not stuck in 1st gear!', 'success');
                } else {
                    log('âœ— Car stuck in 1st gear', 'error');
                }
                
                log('\n=== TEST COMPLETE ===', 'warning');
                if (uniqueGears.length > 1 || uniqueGears[0] !== 1) {
                    log('âœ“âœ“âœ“ ALL TESTS PASSED âœ“âœ“âœ“', 'success');
                } else {
                    log('âœ—âœ—âœ— TEST FAILED âœ—âœ—âœ—', 'error');
                }
                
            } catch (err) {
                log(`\nâœ— Test failed: ${err.message}`, 'error');
                log(err.stack, 'error');
            }
        };
    </script>
</body>
</html>
